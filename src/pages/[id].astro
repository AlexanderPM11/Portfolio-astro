---
// src/pages/projects/[id].astro
import sanitizeHtml from "sanitize-html";
import { ArrowLeft, Github, ExternalLink, Calendar, Clock } from "lucide-astro";
import { techIcons } from "../util/constants/TechIcons";
import Layout from "../layouts/Layout.astro";
import { sanitizeContent } from "../util/constants/sanitizedContent";

interface WpMedia {
  source_url: string;
}

interface ProjectPost {
  id: number;
  title: { rendered: string };
  content?: { rendered: string };
  date: string;
  acf?: {
    githubUrl?: string;
    liveurl?: string;
    techstack?: string[];
  };
  _embedded?: {
    "wp:featuredmedia"?: WpMedia[];
  };
}

// ------------------
// Generación de rutas dinámicas
// ------------------
export async function getStaticPaths() {
  const postsEndpoint = import.meta.env.PUBLIC_WORDPRESS_API_URL;

  if (!postsEndpoint) {
    throw new Error("Falta PUBLIC_WORDPRESS_API_URL");
  }

  const base = postsEndpoint.replace("?rest_route=/wp/v2/posts", "");
  const res = await fetch(`${base}?rest_route=/wp/v2/posts`);
  const posts: ProjectPost[] = await res.json();

  return posts.map((post) => ({
    params: { id: post.id.toString() },
  }));
}

// ------------------
// Obtener ID y fetch del post
// ------------------
const { id } = Astro.params;

if (!id) throw new Error("ID no proporcionado");

let post: ProjectPost | null = null;
let error: string | null = null;

try {
  const postsEndpoint = import.meta.env.PUBLIC_WORDPRESS_API_URL;
  if (!postsEndpoint) throw new Error("Falta PUBLIC_WORDPRESS_API_URL");

  const base = postsEndpoint.replace("?rest_route=/wp/v2/posts", "");
  const url = `${base}?rest_route=/wp/v2/posts/${id}&_embed`;
  const res = await fetch(url);

  if (!res.ok)
    throw new Error(`Error ${res.status}: No se pudo cargar el proyecto`);

  post = await res.json();
} catch (err) {
  error = err instanceof Error ? err.message : "Error cargando el proyecto";
}

if (!post || error) throw new Error(error || "Post no encontrado");

const featured = post._embedded?.["wp:featuredmedia"]?.[0]?.source_url;
const techStack: string[] = Array.isArray(post.acf?.techstack)
  ? post.acf!.techstack
  : [];

const sanitizedContent = sanitizeContent(post.content?.rendered);

// Formatear fecha
const formatDate = (dateString: string) => {
  return new Date(dateString).toLocaleDateString("es-ES", {
    year: "numeric",
    month: "long",
    day: "numeric",
  });
};
---

<Layout>
  <!-- Hero Section Mejorada -->
  <section
    class="relative min-h-[70vh] bg-gradient-to-br from-gray-900 via-gray-800 to-gray-900 flex items-center justify-center overflow-hidden"
  >
    <!-- Background con efectos -->
    <div class="absolute inset-0">
      {
        featured && (
          <img
            src={featured}
            alt={post.title.rendered}
            class="w-full h-full object-cover opacity-20"
            loading="eager"
          />
        )
      }
      <div
        class="absolute inset-0 bg-gradient-to-r from-gray-900/80 to-gray-900/60"
      >
      </div>
      <div
        class="absolute inset-0 bg-[radial-gradient(ellipse_at_center,_var(--tw-gradient-stops))] from-transparent via-gray-900/50 to-gray-900"
      >
      </div>
    </div>

    <!-- Contenido Hero -->
    <div class="relative z-10 max-w-6xl mx-auto px-4 text-center">
      <!-- Meta información -->
      <div
        class="inline-flex items-center gap-4 px-6 py-3 bg-white/10 backdrop-blur-md rounded-full border border-white/20 mb-8"
      >
        <div class="flex items-center gap-2 text-sm text-gray-300">
          <Calendar class="w-4 h-4" />
          <span>{formatDate(post.date)}</span>
        </div>
      </div>

      <!-- Título -->
      <h1
        class="text-4xl md:text-6xl lg:text-7xl font-bold mb-8 bg-gradient-to-r from-white via-gray-200 to-gray-400 bg-clip-text text-transparent leading-tight"
      >
        {post.title.rendered}
      </h1>

      <!-- Tech Stack -->
      {
        techStack.length > 0 && (
          <div class="flex flex-wrap justify-center gap-3 mb-12">
            {techStack.map((t) => {
              const Icon = techIcons[t];
              return (
                <div class="flex items-center gap-2 px-4 py-2 bg-indigo-500/10 backdrop-blur-sm border border-indigo-500/30 rounded-full text-indigo-300 hover:bg-indigo-500/20 hover:scale-105 transition-all duration-300">
                  <Icon class="w-4 h-4" />
                  <span class="text-sm font-medium">{t}</span>
                </div>
              );
            })}
          </div>
        )
      }
    </div>
  </section>

  <!-- Main Content -->
  <main class="bg-gray-900 py-16">
    <div class="max-w-5xl mx-auto px-4">
      <!-- Grid Layout Principal -->
      <div class="">
        <!-- Contenido principal del artículo -->
        <article class="lg:col-span-8">
          <div
            class="bg-gray-800/30 backdrop-blur-sm rounded-2xl border border-gray-700/50 p-8"
          >
            <!-- Contenido del proyecto -->
            <div class="project-content" set:html={sanitizedContent} />
          </div>
        </article>
      </div>

      <!-- Call to Action al final -->
      <div class="mt-16 text-center">
        <div
          class="bg-gradient-to-r from-gray-800/50 to-gray-800/30 rounded-2xl border border-gray-700/50 p-8 backdrop-blur-sm"
        >
          <h2 class="text-2xl font-bold text-white mb-4">
            ¿Te gustó este proyecto?
          </h2>
          <p class="text-gray-400 mb-6 max-w-2xl mx-auto">
            Si te interesa colaborar o tienes alguna pregunta sobre este
            proyecto, no dudes en contactarme.
          </p>
          <div class="flex flex-wrap justify-center gap-4">
            {
              post.acf?.githubUrl && (
                <a
                  href={post.acf.githubUrl}
                  target="_blank"
                  rel="noopener noreferrer"
                  class="inline-flex items-center gap-2 px-6 py-3 bg-gray-700 hover:bg-gray-600 rounded-xl border border-gray-600 text-white font-medium transition-all duration-300 hover:scale-105"
                >
                  <Github class="w-5 h-5" />
                  Explorar código
                </a>
              )
            }
            {
              post.acf?.liveurl && (
                <a
                  href={post.acf.liveurl}
                  target="_blank"
                  rel="noopener noreferrer"
                  class="inline-flex items-center gap-2 px-6 py-3 bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-500 hover:to-purple-500 rounded-xl text-white font-medium transition-all duration-300 hover:scale-105"
                >
                  <ExternalLink class="w-5 h-5" />
                  Ver demo en vivo
                </a>
              )
            }
            <a
              href="/#contact"
              class="inline-flex items-center gap-2 px-6 py-3 bg-indigo-500/10 hover:bg-indigo-500/20 rounded-xl border border-indigo-500/30 text-indigo-300 font-medium transition-all duration-300 hover:scale-105"
            >
              Contactar
            </a>
          </div>
        </div>
      </div>
      <div class="mt-10">
        <a
          href="/"
          class="inline-flex items-center gap-2 text-gray-400 hover:text-orange-500 transition-colors duration-200 group font-medium"
        >
          <ArrowLeft
            class="w-4 h-4 transition-transform group-hover:-translate-x-1"
          />
          <span
            class="border-b border-transparent group-hover:border-current transition-all duration-200"
          >
            Volver a proyectos
          </span>
        </a>
      </div>
    </div>
  </main>
</Layout>
