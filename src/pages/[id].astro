---
// src/pages/projects/[id].astro
import { ArrowLeft, Github, ExternalLink, Calendar, Clock } from "lucide-astro";
import { techIcons } from "../util/constants/TechIcons";
import Layout from "../layouts/Layout.astro";
import { sanitizeContent } from "../util/constants/sanitizedContent";
import {
  getProjectById,
  getProjectPaths,
} from "../services/blog/ProjectService";
import type { ProjectPost } from "../interface/Project/ProjectInterface";
import { Icon } from "astro-icon/components";

const { id } = Astro.params;

export async function getStaticPaths() {
  return await getProjectPaths();
}

export async function get(id: string) {
  if (!id) {
    throw new Error("❌ ID de proyecto no proporcionado o inválido");
  }

  try {
    const post = await getProjectById(Number(id));
    return { props: { post } };
  } catch (err) {
    console.error("Error al obtener el proyecto:", err);
    return {
      props: {
        post: null,
        error: "No se pudo cargar el proyecto solicitado.",
      },
    };
  }
}

// ------------------
// Variables disponibles en el template
// ------------------
let post: ProjectPost;

const data = await get(id);
post = data.props.post!;

const sanitizedContent = sanitizeContent(post.content?.rendered || "");

// Formatear fecha
const formatDate = (dateString: string) => {
  return new Date(dateString).toLocaleDateString("es-ES", {
    year: "numeric",
    month: "long",
    day: "numeric",
  });
};
---

<Layout>
  <!-- Hero Section -->
  <section
    class="h-full relative bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900 pt-24 pb-20 lg:pt-32 lg:pb-28 overflow-hidden"
  >
    <!-- Background Elements -->
    <div class="absolute inset-0">
      <div
        class="absolute top-0 left-0 w-96 h-96 bg-blue-500/5 rounded-full blur-3xl -translate-x-1/2 -translate-y-1/2"
      >
      </div>
      <div
        class="absolute bottom-0 right-0 w-96 h-96 bg-orange-500/5 rounded-full blur-3xl translate-x-1/2 translate-y-1/2"
      >
      </div>
      {
        post.image && (
          <img
            src={post.image}
            alt={post.title.rendered}
            class="w-full h-full object-cover opacity-10 scale-110"
            loading="eager"
          />
        )
      }
    </div>

    <!-- Content Container -->
    <div class="relative z-10 max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
      <!-- Breadcrumb -->
      <nav class="flex items-center gap-2 text-sm text-gray-400 mb-8">
        <a href="/" class="hover:text-orange-400 transition-colors duration-200"
          >Inicio</a
        >
        <span class="text-gray-600">/</span>
        <a
          href="/#projects"
          class="hover:text-orange-400 transition-colors duration-200"
          >Proyectos</a
        >
        <span class="text-gray-600">/</span>
        <span class="text-orange-400 truncate">{post.title.rendered}</span>
      </nav>

      <!-- Meta Information -->
      <div class="flex flex-wrap items-center gap-4 mb-8">
        <div
          class="flex items-center gap-2 px-4 py-2 bg-white/5 backdrop-blur-sm rounded-full border border-white/10"
        >
          <Calendar class="w-4 h-4 text-orange-400" />
          <span class="text-sm text-gray-300">{formatDate(post.date)}</span>
        </div>
        {
          post.category && (
            <span class="px-3 py-1 bg-orange-500/20 text-orange-400 rounded-full text-sm font-medium border border-orange-500/30">
              {post.category}
            </span>
          )
        }
      </div>

      <!-- Title -->
      <h1
        class="text-4xl md:text-5xl lg:text-6xl font-bold text-white mb-8 leading-tight tracking-tight"
      >
        {post.title.rendered}
      </h1>

      <!-- Excerpt -->
      {
        post.description && (
          <p class="text-base text-gray-400 mb-10">
            {post.description.rendered.replace(/<[^>]*>/g, "").slice(0, 250)}
            {post.description.rendered.length > 250 ? "..." : ""}
          </p>
        )
      }

      <!-- Tech Stack -->
      {
        post.techStack?.length > 0 && (
          <div class="mb-12">
            <h3 class="text-lg font-semibold text-gray-400 mb-4">
              Tecnologías utilizadas
            </h3>
            <div class="flex flex-wrap gap-3">
              {post.techStack.map((tech) => {
                const iconData = techIcons[tech];
                return iconData ? (
                  <div class="relative group">
                    <div class="flex items-center gap-2 px-4 py-3 bg-white/5 backdrop-blur-sm rounded-xl border border-white/10 hover:border-orange-400/50 transition-all duration-300 hover:scale-105">
                      <Icon
                        name={iconData.name}
                        class="w-5 h-5 transition-transform duration-300"
                        style={`color: ${iconData.color}`}
                      />
                      <span class="text-sm font-medium text-gray-300">
                        {iconData.title}
                      </span>
                    </div>
                  </div>
                ) : null;
              })}
            </div>
          </div>
        )
      }

      <!-- Action Buttons -->
      <div class="flex flex-wrap gap-4">
        {
          post.acf?.githubUrl && (
            <a
              href={post.acf.githubUrl}
              target="_blank"
              rel="noopener noreferrer"
              class="inline-flex items-center gap-3 px-6 py-4 bg-gray-800 hover:bg-gray-700 rounded-xl border border-gray-600 text-white font-medium transition-all duration-300 hover:scale-105 hover:shadow-lg"
            >
              <Github class="w-5 h-5" />
              <span>Ver código</span>
            </a>
          )
        }
        {
          post.acf?.liveurl && (
            <a
              href={post.acf.liveurl}
              target="_blank"
              rel="noopener noreferrer"
              class="inline-flex items-center gap-3 px-6 py-4 bg-gradient-to-r from-orange-500 to-amber-500 hover:from-orange-600 hover:to-amber-600 rounded-xl text-white font-medium transition-all duration-300 hover:scale-105 hover:shadow-lg shadow-orange-500/25"
            >
              <ExternalLink class="w-5 h-5" />
              <span>Ver demo</span>
            </a>
          )
        }
      </div>
    </div>
  </section>

  <!-- Main Content -->
  <main class="bg-gray-950 py-20">
    <div class="max-w-5xl mx-auto px-6">
      <!-- Contenedor del artículo -->
      <article
        class="prose prose-invert prose-orange max-w-none prose-headings:text-white prose-a:text-orange-400 prose-strong:text-white prose-blockquote:border-orange-500 prose-img:rounded-xl prose-pre:bg-gray-900 prose-pre:text-gray-200 prose-code:text-orange-400"
      >
        <div
          class="bg-gray-900/60 p-10 rounded-2xl border border-gray-800 shadow-lg"
        >
          <div class="project-content" set:html={sanitizedContent} />
        </div>
      </article>

      <!-- Línea divisoria -->
      <div
        class="my-16 h-px bg-gradient-to-r from-transparent via-gray-700 to-transparent"
      >
      </div>

      <!-- CTA final -->
      <section class="text-center">
        <h2 class="text-2xl font-semibold text-white mb-4">
          ¿Te gustó este proyecto?
        </h2>
        <p class="text-gray-400 mb-8 max-w-2xl mx-auto">
          Si te interesa colaborar o tienes alguna pregunta sobre este proyecto,
          no dudes en contactarme.
        </p>

        <div class="flex flex-wrap justify-center gap-4">
          {
            post.acf?.githubUrl && (
              <a
                href={post.acf.githubUrl}
                target="_blank"
                rel="noopener noreferrer"
                class="inline-flex items-center gap-2 px-6 py-3 bg-gray-800 hover:bg-gray-700 border border-gray-700 rounded-lg text-white transition-all hover:scale-105"
              >
                <Github class="w-5 h-5" />
                Código Fuente
              </a>
            )
          }

          {
            post.acf?.liveurl && (
              <a
                href={post.acf.liveurl}
                target="_blank"
                rel="noopener noreferrer"
                class="inline-flex items-center gap-3 px-6 py-4 bg-gradient-to-r from-orange-500 to-amber-500 hover:from-orange-600 hover:to-amber-600 rounded-xl text-white font-medium transition-all duration-300 hover:scale-105 hover:shadow-lg shadow-orange-500/25"
              >
                <ExternalLink class="w-5 h-5" />
                Ver Demo
              </a>
            )
          }

          <a
            href="/#contact"
            class="inline-flex items-center gap-2 px-6 py-3 bg-indigo-500/10 hover:bg-indigo-500/20 border border-indigo-500/30 text-indigo-300 rounded-lg font-medium transition-all hover:scale-105"
          >
            Contactar
          </a>
        </div>
      </section>

      <!-- Volver -->
      <div class="mt-12 text-center">
        <a
          href="/"
          class="inline-flex items-center gap-2 text-gray-400 hover:text-orange-500 transition-colors duration-200 font-medium"
        >
          <ArrowLeft class="w-4 h-4" />
          <span>Volver a proyectos</span>
        </a>
      </div>
    </div>
  </main>

  <!--  -->
</Layout>
