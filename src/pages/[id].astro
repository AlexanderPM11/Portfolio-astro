---
// src/pages/projects/[id].astro
import { ArrowLeft, Github, ExternalLink, Calendar, Clock } from "lucide-astro";
import { techIcons } from "../util/constants/TechIcons";
import Layout from "../layouts/Layout.astro";
import { sanitizeContent } from "../util/constants/sanitizedContent";
import {
  getProjectById,
  getProjectPaths,
} from "../services/blog/ProjectService";
import type { ProjectPost } from "../interface/Project/ProjectInterface";
import { Icon } from "astro-icon/components";

const { id } = Astro.params;

export async function getStaticPaths() {
  return await getProjectPaths();
}

export async function get(id: string) {
  if (!id) {
    throw new Error("❌ ID de proyecto no proporcionado o inválido");
  }

  try {
    const post = await getProjectById(Number(id));
    return { props: { post } };
  } catch (err) {
    console.error("Error al obtener el proyecto:", err);
    return {
      props: {
        post: null,
        error: "No se pudo cargar el proyecto solicitado.",
      },
    };
  }
}

// ------------------
// Variables disponibles en el template
// ------------------
let post: ProjectPost;

const data = await get(id);
post = data.props.post!;

const sanitizedContent = sanitizeContent(post.content?.rendered || "");

// Formatear fecha
const formatDate = (dateString: string) => {
  return new Date(dateString).toLocaleDateString("es-ES", {
    year: "numeric",
    month: "long",
    day: "numeric",
  });
};
---

<Layout>
  <!-- Hero Section -->
  <section
    class="relative min-h-screen flex flex-col justify-center bg-linear-to-br from-slate-900 via-slate-800 to-slate-900 pt-24 pb-20 lg:pt-32 lg:pb-28 overflow-hidden"
  >
    <!-- Background Elements -->
    <div class="absolute inset-0">
      <div
        class="absolute top-0 left-0 w-96 h-96 bg-blue-500/5 rounded-full blur-3xl -translate-x-1/2 -translate-y-1/2"
      >
      </div>
      <div
        class="absolute bottom-0 right-0 w-96 h-96 bg-orange-500/5 rounded-full blur-3xl translate-x-1/2 translate-y-1/2"
      >
      </div>
      {
        post.image && (
          <img
            src={post.image}
            alt={post.title.rendered}
            class="w-full h-full object-cover opacity-10 scale-110"
            loading="eager"
          />
        )
      }
    </div>

    <!-- Content Container -->
    <div class="relative z-10 max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
      <!-- Breadcrumb -->
      <nav class="flex items-center gap-2 text-sm text-gray-400 mb-8">
        <a href="/" class="hover:text-orange-400 transition-colors duration-200"
          >Inicio</a
        >
        <span class="text-gray-600">/</span>
        <a
          href="/#projects"
          class="hover:text-orange-400 transition-colors duration-200"
          >Proyectos</a
        >
        <span class="text-gray-600">/</span>
        <span class="text-orange-400 truncate">{post.title.rendered}</span>
      </nav>

      <!-- Meta Information -->
      <div class="flex flex-wrap items-center gap-4 mb-8">
        <div
          class="flex items-center gap-2 px-4 py-2 bg-white/5 backdrop-blur-sm rounded-full border border-white/10"
        >
          <Calendar class="w-4 h-4 text-orange-400" />
          <span class="text-sm text-gray-300">{formatDate(post.date)}</span>
        </div>
        {
          post.category && (
            <span class="px-3 py-1 bg-orange-500/20 text-orange-400 rounded-full text-sm font-medium border border-orange-500/30">
              {post.category}
            </span>
          )
        }
      </div>

      <!-- Title -->
      <h1
        class="text-4xl md:text-5xl lg:text-6xl font-bold text-white mb-8 leading-tight tracking-tight"
        set:html={post.title.rendered}
      />

      <!-- Excerpt -->
      {
        post.description && (
          <p class="text-base text-gray-400 mb-10">
            {post.description.rendered.replace(/<[^>]*>/g, "").slice(0, 250)}
            {post.description.rendered.length > 250 ? "..." : ""}
          </p>
        )
      }

      <!-- Tech Stack -->
      {
        post.techStack?.length > 0 && (
          <div class="mb-12">
            <h3 class="text-lg font-semibold text-gray-400 mb-4">
              Tecnologías utilizadas
            </h3>
            <div class="flex flex-wrap gap-3">
              {post.techStack.map((tech) => {
                const iconData = techIcons[tech];
                return iconData ? (
                  <div class="relative group">
                    <div class="flex items-center gap-2 px-4 py-3 bg-white/5 backdrop-blur-sm rounded-xl border border-white/10 hover:border-orange-400/50 transition-all duration-300 hover:scale-105">
                      <Icon
                        name={iconData.name}
                        class="w-5 h-5 transition-transform duration-300"
                        style={`color: ${iconData.color}`}
                      />
                      <span class="text-sm font-medium text-gray-300">
                        {iconData.title}
                      </span>
                    </div>
                  </div>
                ) : null;
              })}
            </div>
          </div>
        )
      }

      <!-- Action Buttons -->
      <div class="flex flex-wrap gap-4">
        {
          post.acf?.githubUrl && (
            <a
              href={post.acf.githubUrl}
              target="_blank"
              rel="noopener noreferrer"
              class="inline-flex items-center gap-3 px-6 py-4 bg-gray-800 hover:bg-gray-700 rounded-xl border border-gray-600 text-white font-medium transition-all duration-300 hover:scale-105 hover:shadow-lg"
            >
              <Github class="w-5 h-5" />
              <span>Ver código</span>
            </a>
          )
        }
        {
          post.acf?.liveurl && (
            <a
              href={post.acf.liveurl}
              target="_blank"
              rel="noopener noreferrer"
              class="inline-flex items-center gap-3 px-6 py-4 bg-gradient-to-r from-orange-500 to-amber-500 hover:from-orange-600 hover:to-amber-600 rounded-xl text-white font-medium transition-all duration-300 hover:scale-105 hover:shadow-lg shadow-orange-500/25"
            >
              <ExternalLink class="w-5 h-5" />
              <span>Ver demo</span>
            </a>
          )
        }
      </div>
    </div>
  </section>

  <!-- Main Content -->
  <main
    class="bg-gradient-to-br from-slate-950 via-slate-900 to-slate-950 py-20"
  >
    <div class="max-w-4xl mx-auto px-6">
      <!-- Contenedor del artículo mejorado -->
      <article
        class="prose prose-invert prose-lg prose-slate max-w-none
               prose-headings:text-white prose-headings:font-bold
               prose-h1:text-3xl prose-h2:text-2xl prose-h3:text-xl
               prose-p:text-slate-300 prose-p:leading-relaxed
               prose-a:text-orange-400 prose-a:no-underline hover:prose-a:text-orange-300
               prose-strong:text-white prose-strong:font-semibold
               prose-blockquote:border-l-orange-400 prose-blockquote:text-slate-400
               prose-blockquote:bg-slate-800/50 prose-blockquote:py-2
               prose-ul:text-slate-300 prose-ol:text-slate-300
               prose-li:text-slate-300 prose-li:leading-relaxed
               prose-img:rounded-2xl prose-img:shadow-2xl
               prose-pre:bg-slate-800 prose-pre:border prose-pre:border-slate-700
               prose-code:text-orange-300 prose-code:bg-slate-800/50
               prose-code:px-1.5 prose-code:py-0.5 prose-code:rounded-md
               prose-table:text-slate-300 prose-th:bg-slate-800/50
               prose-td:border-t prose-td:border-slate-700"
      >
        <div
          class="bg-slate-800/30 backdrop-blur-sm p-8 lg:p-12 rounded-3xl
                 border border-slate-700/50 shadow-2xl
                 hover:shadow-slate-700/20 transition-shadow duration-300"
        >
          <div class="project-content" set:html={sanitizedContent} />
        </div>
      </article>

      <!-- Línea divisoria decorativa -->
      <div class="my-16 relative">
        <div
          class="h-px bg-gradient-to-r from-transparent via-slate-600 to-transparent"
        >
        </div>
        <div
          class="absolute left-1/2 top-1/2 transform -translate-x-1/2 -translate-y-1/2"
        >
          <div class="w-3 h-3 bg-orange-400 rounded-full ring-4 ring-slate-900">
          </div>
        </div>
      </div>

      <!-- CTA final mejorado -->
      <section class="text-center">
        <div
          class="bg-slate-800/30 backdrop-blur-sm rounded-3xl border border-slate-700/50 p-8 lg:p-12 shadow-xl"
        >
          <h2
            class="text-3xl font-bold text-white mb-6 bg-gradient-to-r from-white to-slate-300 bg-clip-text text-transparent"
          >
            ¿Te gustó este proyecto?
          </h2>
          <p
            class="text-slate-400 text-lg mb-8 max-w-2xl mx-auto leading-relaxed"
          >
            Si te interesa colaborar o tienes alguna pregunta sobre la
            implementación de este proyecto, estaré encantado de conversar
            contigo.
          </p>

          <div class="flex flex-wrap justify-center gap-4">
            {
              post.acf?.githubUrl && (
                <a
                  href={post.acf.githubUrl}
                  target="_blank"
                  rel="noopener noreferrer"
                  class="inline-flex items-center gap-3 px-6 py-4 bg-slate-700 hover:bg-slate-600 
                       border border-slate-600 rounded-xl text-white font-semibold 
                       transition-all duration-300 hover:scale-105 hover:shadow-lg 
                       group"
                >
                  <Github class="w-5 h-5 group-hover:scale-110 transition-transform" />
                  <span>Código Fuente</span>
                </a>
              )
            }

            {
              post.acf?.liveurl && (
                <a
                  href={post.acf.liveurl}
                  target="_blank"
                  rel="noopener noreferrer"
                  class="inline-flex items-center gap-3 px-6 py-4 
                       bg-gradient-to-r from-orange-500 to-amber-500 
                       hover:from-orange-600 hover:to-amber-600 
                       rounded-xl text-white font-semibold 
                       transition-all duration-300 hover:scale-105 
                       hover:shadow-lg shadow-orange-500/25 group"
                >
                  <ExternalLink class="w-5 h-5 group-hover:scale-110 transition-transform" />
                  <span>Ver Demo en Vivo</span>
                </a>
              )
            }

            <a
              href="/#contact"
              class="inline-flex items-center gap-3 px-6 py-4
                     bg-green-600 hover:bg-green-600
                     border border-blue-500/30 text-white
                     rounded-xl font-semibold transition-all duration-300
                     hover:scale-105 hover:shadow-lg hover:shadow-green-600
                     group"
            >
              <span>Iniciar Conversación</span>
            </a>
          </div>
        </div>
      </section>

      <!-- Volver mejorado -->
      <div class="mt-12 text-center">
        <a
          href="/#projects"
          class="inline-flex items-center gap-3 text-slate-400 hover:text-orange-400
                 transition-all duration-300 font-semibold group"
        >
          <ArrowLeft
            class="w-5 h-5 transition-transform group-hover:-translate-x-1"
          />
          <span
            class="border-b border-transparent group-hover:border-current transition-all duration-200"
          >
            Volver a todos los proyectos
          </span>
        </a>
      </div>
    </div>
  </main>

  <!--  -->
</Layout>
