---
import { ChevronLeft, ChevronRight, Search, Filter } from "lucide-astro";
import { fetchCategories, fetchPosts } from "../../services/wordpress";
import Layout from "../../layouts/Layout.astro";

// Fetch inicial de datos
const [categories, initialData] = await Promise.all([
  fetchCategories(),
  fetchPosts("all", 1),
]);

const totalPosts = initialData.totalItem;
---

<Layout>
  <!-- Hero Section -->
  <section
    class="relative min-h-[50vh] bg-linear-to-br from-gray-900 via-gray-800 to-gray-900 flex items-center justify-center overflow-hidden"
  >
    <div
      class="absolute inset-0 bg-[radial-gradient(ellipse_at_center,var(--tw-gradient-stops))] from-orange-500/10 via-transparent to-transparent"
    >
    </div>
    <div
      class="absolute inset-0 bg-linear-to-r from-gray-900/90 to-gray-900/80"
    >
    </div>

    <div class="relative z-10 max-w-4xl mx-auto px-4 text-center">
      <h1
        class="text-5xl md:text-6xl font-bold mb-6 bg-linear-to-r from-white via-gray-200 to-gray-400 bg-clip-text text-transparent leading-tight"
      >
        Mi <span
          class="bg-linear-to-r from-orange-400 to-orange-600 bg-clip-text text-transparent"
          >Blog</span
        >
      </h1>
      <p class="text-xl text-gray-300 mb-8 max-w-2xl mx-auto leading-relaxed">
        Descubre artículos, tutoriales y reflexiones sobre desarrollo web,
        tecnología y mejores prácticas en programación.
      </p>

      <div class="flex flex-wrap justify-center gap-8 mb-8">
        <div class="text-center">
          <div class="text-2xl font-bold text-orange-400">
            {initialData.totalPages}
          </div>
          <div class="text-gray-400 text-sm">Artículos totales</div>
        </div>
        <div class="text-center">
          <div class="text-2xl font-bold text-orange-400">
            {categories.length}
          </div>
          <div class="text-gray-400 text-sm">Categorías</div>
        </div>
      </div>
    </div>
  </section>

  <!-- Contenido Dinámico -->
  <section class="bg-gray-900 py-12 px-4">
    <div class="max-w-6xl mx-auto">
      <!-- Filtros -->
      <div
        class="bg-gray-800/50 backdrop-blur-sm rounded-2xl border border-gray-700/50 p-6 mb-12"
      >
        <div
          class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4"
        >
          <div class="flex items-center gap-3">
            <Filter class="w-5 h-5 text-orange-400" />
            <h3 class="text-lg font-semibold text-white">
              Filtrar por categoría
            </h3>
          </div>

          <div id="categories-container" class="flex flex-wrap gap-3">
            <button
              data-category="all"
              class="category-btn inline-flex items-center gap-2 px-4 py-2 rounded-full border transition-all duration-300 bg-orange-500 border-orange-500 text-white shadow-lg shadow-orange-500/25"
            >
              <span>Todas</span>
              <span class="text-sm opacity-75">({totalPosts})</span>
            </button>

            {
              categories
                .filter((cat) => cat.slug !== "all" && cat.count > 0)
                .map((cat) => (
                  <button
                    data-category={cat.slug}
                    class="category-btn inline-flex items-center gap-2 px-4 py-2 rounded-full border transition-all duration-300 bg-gray-700/50 border-gray-600 text-gray-300 hover:bg-gray-600 hover:border-gray-500"
                  >
                    <span>{cat.name}</span>
                    <span class="text-sm opacity-75">({cat.count})</span>
                  </button>
                ))
            }
          </div>
        </div>

        <div
          id="filter-indicator"
          class="hidden mt-4 items-center gap-2 text-sm text-orange-400"
        >
          <span>Filtrando por:</span>
          <span id="filter-name" class="font-semibold"></span>
          <button
            id="clear-filter"
            class="ml-2 text-gray-400 hover:text-white transition-colors"
          >
            × Limpiar filtro
          </button>
        </div>
      </div>

      <!-- Loading Spinner -->
      <div id="loading" class="hidden text-center py-16">
        <div
          class="inline-block w-12 h-12 border-4 border-orange-500 border-t-transparent rounded-full animate-spin"
        >
        </div>
        <p class="text-gray-400 mt-4">Cargando posts...</p>
      </div>

      <!-- Contador de resultados -->
      <div id="results-info" class="flex items-center justify-between mb-8">
        <p class="text-gray-400">
          Mostrando <span id="posts-count" class="text-white font-semibold"
            >{initialData.posts.length}</span
          > posts
          <span id="category-info"></span>
        </p>
        <p class="text-gray-400 text-sm">
          Página <span id="current-page" class="text-white font-semibold"
            >1</span
          > de
          <span id="total-pages" class="text-white font-semibold"
            >{initialData.totalPages}</span
          >
        </p>
      </div>

      <!-- Posts Container -->
      <div
        id="posts-container"
        class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8 min-h-[400px]"
      >
        <!-- Los posts se cargarán aquí dinámicamente -->
      </div>

      <!-- Empty State -->
      <div
        id="empty-state"
        class="hidden text-center py-16 bg-gray-800/30 rounded-2xl border border-gray-700/50"
      >
        <div class="max-w-md mx-auto">
          <div
            class="w-16 h-16 bg-gray-700 rounded-full flex items-center justify-center mx-auto mb-4"
          >
            <svg
              class="w-8 h-8 text-gray-500"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
            </svg>
          </div>
          <h3 class="text-xl font-semibold text-white mb-2">
            No se encontraron posts
          </h3>
          <p id="empty-message" class="text-gray-400 mb-6">
            No hay posts disponibles en este momento.
          </p>
          <button
            id="view-all-btn"
            class="inline-flex items-center gap-2 px-6 py-3 bg-orange-500 hover:bg-orange-600 rounded-xl text-white font-medium transition-all duration-300"
          >
            Ver todos los posts
          </button>
        </div>
      </div>

      <!-- Paginación -->
      <div id="pagination" class="flex justify-center items-center gap-3 mt-16">
        <button
          id="prev-page"
          class="flex items-center justify-center w-12 h-12 rounded-xl border transition-all duration-300 bg-gray-800 border-gray-700 text-gray-600 pointer-events-none"
          aria-label="Página anterior"
        >
          <svg
            class="w-5 h-5"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M15 19l-7-7 7-7"></path>
          </svg>
        </button>

        <div id="page-numbers" class="flex items-center gap-2">
          <!-- Los números de página se generarán aquí -->
        </div>

        <button
          id="next-page"
          class="flex items-center justify-center w-12 h-12 rounded-xl border transition-all duration-300 bg-gray-800 border-gray-600 text-white hover:bg-orange-500 hover:border-orange-500 hover:scale-105"
          aria-label="Página siguiente"
        >
          <svg
            class="w-5 h-5"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M9 5l7 7-7 7"></path>
          </svg>
        </button>
      </div>
    </div>
  </section>
</Layout>

<script is:inline define:vars={{ categories, initialData, totalPosts }}>
  // Pasar datos a variables globales para el script del cliente
  window.__BLOG_CATEGORIES__ = categories;
  window.__BLOG_INITIAL_DATA__ = initialData;
  window.__BLOG_TOTAL_POSTS__ = totalPosts;
</script>

<script>
  // Datos iniciales pasados desde Astro
  const categories = window.__BLOG_CATEGORIES__;
  const initialData = window.__BLOG_INITIAL_DATA__;
  const totalPosts = window.__BLOG_TOTAL_POSTS__;

  // Estado de la aplicación
  let state = {
    currentCategory: "all",
    currentPage: 1,
    totalPages: initialData.totalPages,
    posts: initialData.posts,
    isLoading: false,
  };
  // console.log("Initial State:", state);
  // console.log("Initial State:", initialData.posts);

  // Elementos del DOM
  const elements = {
    postsContainer: document.getElementById("posts-container")!,
    loading: document.getElementById("loading")!,
    emptyState: document.getElementById("empty-state")!,
    emptyMessage: document.getElementById("empty-message")!,
    viewAllBtn: document.getElementById("view-all-btn")!,
    resultsInfo: document.getElementById("results-info")!,
    postsCount: document.getElementById("posts-count")!,
    categoryInfo: document.getElementById("category-info")!,
    currentPage: document.getElementById("current-page")!,
    totalPages: document.getElementById("total-pages")!,
    pagination: document.getElementById("pagination")!,
    pageNumbers: document.getElementById("page-numbers")!,
    prevBtn: document.getElementById("prev-page")! as HTMLButtonElement,
    nextBtn: document.getElementById("next-page")! as HTMLButtonElement,
    filterIndicator: document.getElementById("filter-indicator")!,
    filterName: document.getElementById("filter-name")!,
    clearFilter: document.getElementById("clear-filter")! as HTMLButtonElement,
  };

  // Función para crear una card de blog
  function createBlogCard(post: any) {
    const card = document.createElement("article");
    card.className =
      "bg-gray-800/50 rounded-2xl border border-gray-700/50 overflow-hidden hover:border-orange-500/50 transition-all duration-300 hover:scale-[1.02] group";

    // Múltiples posibles nombres de campos para la imagen
    const imageUrl =
      post._embedded?.["wp:featuredmedia"]?.[0]?.source_url ||
      "https://images.unsplash.com/photo-1517694712202-14dd9538aa97?q=80&w=1470&auto=format&fit=crop";

    // Múltiples posibles nombres para el título
    const title = post.title?.rendered || post.title || "Sin título";

    // Múltiples posibles nombres para el slug
    const slug = post.slug || post.id || "";

    // Múltiples posibles nombres para la categoría
    const autor = post._embedded?.["author"]?.[0]?.name;

    // Múltiples posibles nombres para la fecha
    const date = new Date(
      post.date || post.published || Date.now()
    ).toLocaleDateString("es-ES", {
      year: "numeric",
      month: "long",
      day: "numeric",
    });

    // Validar y procesar excerpt de forma segura
    let excerpt = "";
    const excerptContent =
      post.excerpt?.rendered ||
      post.excerpt ||
      post.content?.rendered ||
      post.content ||
      "";

    if (excerptContent) {
      if (typeof excerptContent === "string") {
        // Remover HTML y limitar caracteres
        const tempDiv = document.createElement("div");
        tempDiv.innerHTML = excerptContent;
        excerpt =
          (tempDiv.textContent || tempDiv.innerText || "")
            .substring(0, 150)
            .trim() + "...";
      } else {
        excerpt = "Lee este artículo para descubrir más...";
      }
    } else {
      excerpt = "Lee este artículo para descubrir más...";
    }

    card.innerHTML = `
      <div class="aspect-video overflow-hidden bg-gray-700">
        <a 
          href="/blog/${slug}" 
        >
         <img 
          src="${imageUrl}" 
          alt="${title}"
          class="w-full h-full object-cover group-hover:scale-110 transition-transform duration-300"
        />
        </a>
        
      </div>
      <div class="p-6">
        <div class="flex items-center gap-2 mb-3">
          <span class="px-3 py-1 bg-orange-500/20 text-orange-400 text-xs font-medium rounded-full">
            ${autor}
          </span>
          <span class="text-gray-500 text-xs">${date}</span>
        </div>
        <a 
          href="/blog/${slug}" 
        >
         <h3 class="text-xl font-bold text-white mb-3 group-hover:text-orange-400 transition-colors">
          ${title}
        </h3>
        </a>
        
        <p class="text-gray-400 text-sm mb-4 line-clamp-3">
          ${excerpt}
        </p>
        <a 
          href="/blog/${slug}" 
          class="inline-flex items-center gap-2 text-orange-400 hover:text-orange-300 font-medium transition-colors"
        >
          Leer más
          <svg class="w-4 h-4 group-hover:translate-x-1 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
          </svg>
        </a>
      </div>
    `;

    return card;
  }

  // Función para renderizar posts
  function renderPosts() {
    elements.postsContainer.innerHTML = "";

    if (state.posts.length === 0) {
      elements.postsContainer.classList.add("hidden");
      elements.emptyState.classList.remove("hidden");
      elements.resultsInfo.classList.add("hidden");
      elements.pagination.classList.add("hidden");

      const categoryName = categories.find(
        (cat: any) => cat.slug === state.currentCategory
      )?.name;
      elements.emptyMessage.textContent =
        state.currentCategory === "all"
          ? "No hay posts disponibles en este momento."
          : `No hay posts en la categoría "${categoryName}".`;

      if (state.currentCategory !== "all") {
        elements.viewAllBtn.classList.remove("hidden");
      } else {
        elements.viewAllBtn.classList.add("hidden");
      }
    } else {
      elements.postsContainer.classList.remove("hidden");
      elements.emptyState.classList.add("hidden");
      elements.resultsInfo.classList.remove("hidden");
      elements.pagination.classList.remove("hidden");

      state.posts.forEach((post: any) => {
        const card = createBlogCard(post);
        elements.postsContainer.appendChild(card);
      });
    }

    updateUI();
  }

  // Función para actualizar la UI
  function updateUI() {
    elements.postsCount.textContent = state.posts.length;
    elements.currentPage.textContent = state.currentPage.toString();
    elements.totalPages.textContent = state.totalPages;

    // Actualizar info de categoría
    if (state.currentCategory !== "all") {
      const category = categories.find(
        (cat: any) => cat.slug === state.currentCategory
      );
      const categoryName = category?.name || state.currentCategory;
      elements.categoryInfo.innerHTML = ` en <span class="text-orange-400 font-semibold">${categoryName}</span>`;
      elements.filterIndicator.classList.remove("hidden");
      elements.filterIndicator.classList.add("flex");
      elements.filterName.textContent = categoryName;
    } else {
      elements.categoryInfo.innerHTML = "";
      elements.filterIndicator.classList.add("hidden");
      elements.filterIndicator.classList.remove("flex");
    }

    // Actualizar botones de paginación
    updatePaginationButtons();
    renderPageNumbers();

    // Mostrar/ocultar paginación según sea necesario
    if (state.totalPages <= 1) {
      elements.pagination.classList.add("hidden");
    } else {
      elements.pagination.classList.remove("hidden");
    }
  }

  // Función para actualizar botones de paginación
  function updatePaginationButtons() {
    if (state.currentPage === 1) {
      elements.prevBtn.classList.add(
        "pointer-events-none",
        "text-gray-600",
        "border-gray-700"
      );
      elements.prevBtn.classList.remove(
        "text-white",
        "border-gray-600",
        "hover:bg-orange-500",
        "hover:border-orange-500",
        "hover:scale-105"
      );
    } else {
      elements.prevBtn.classList.remove(
        "pointer-events-none",
        "text-gray-600",
        "border-gray-700"
      );
      elements.prevBtn.classList.add(
        "text-white",
        "border-gray-600",
        "hover:bg-orange-500",
        "hover:border-orange-500",
        "hover:scale-105"
      );
    }

    if (state.currentPage === state.totalPages) {
      elements.nextBtn.classList.add(
        "pointer-events-none",
        "text-gray-600",
        "border-gray-700"
      );
      elements.nextBtn.classList.remove(
        "text-white",
        "border-gray-600",
        "hover:bg-orange-500",
        "hover:border-orange-500",
        "hover:scale-105"
      );
    } else {
      elements.nextBtn.classList.remove(
        "pointer-events-none",
        "text-gray-600",
        "border-gray-700"
      );
      elements.nextBtn.classList.add(
        "text-white",
        "border-gray-600",
        "hover:bg-orange-500",
        "hover:border-orange-500",
        "hover:scale-105"
      );
    }
  }

  // Función para generar números de página
  function generatePageNumbers() {
    const pages = [];
    const maxVisiblePages = 7;

    if (state.totalPages <= maxVisiblePages) {
      for (let i = 1; i <= state.totalPages; i++) {
        pages.push(i);
      }
    } else {
      pages.push(1);

      let startPage = Math.max(2, state.currentPage - 1);
      let endPage = Math.min(state.totalPages - 1, state.currentPage + 1);

      if (state.currentPage <= 3) {
        startPage = 2;
        endPage = 4;
      } else if (state.currentPage >= state.totalPages - 2) {
        startPage = state.totalPages - 3;
        endPage = state.totalPages - 1;
      }

      if (startPage > 2) {
        pages.push("...");
      }

      for (let i = startPage; i <= endPage; i++) {
        pages.push(i);
      }

      if (endPage < state.totalPages - 1) {
        pages.push("...");
      }

      pages.push(state.totalPages);
    }

    return pages;
  }

  // Función para renderizar números de página
  function renderPageNumbers() {
    const pageNumbers = generatePageNumbers();
    elements.pageNumbers.innerHTML = "";

    pageNumbers.forEach((pageNum) => {
      if (pageNum === "...") {
        const dots = document.createElement("span");
        dots.className =
          "w-12 h-12 flex items-center justify-center text-gray-500";
        dots.textContent = "...";
        elements.pageNumbers.appendChild(dots);
      } else {
        const btn = document.createElement("button");
        btn.className = `w-12 h-12 rounded-xl border flex items-center justify-center transition-all duration-300 ${
          state.currentPage === pageNum
            ? "bg-orange-500 border-orange-500 text-white shadow-lg shadow-orange-500/25 scale-105"
            : "bg-gray-800 border-gray-600 text-white hover:bg-gray-700 hover:scale-105"
        }`;
        btn.textContent = pageNum;
        btn.addEventListener("click", () => changePage(pageNum));
        elements.pageNumbers.appendChild(btn);
      }
    });
  }

  // Función para cargar posts
  async function loadPosts(category: any, page: any) {
    if (state.isLoading) return;

    state.isLoading = true;
    elements.loading.classList.remove("hidden");
    elements.postsContainer.classList.add("opacity-50");

    try {
      // Importar dinámicamente la función fetchPosts
      const { fetchPosts } = await import("../../services/wordpress.js");
      const data = await fetchPosts(category, page);

      state.posts = data.posts;
      state.totalPages = data.totalPages;
      state.currentPage = page;
      state.currentCategory = category;

      // Actualizar URL sin recargar
      const url = new URL(window.location.href);
      url.searchParams.set("category", category);
      url.searchParams.set("page", page.toString());
      window.history.pushState({}, "", url.toString());

      renderPosts();

      // Scroll suave al inicio de la sección
      document.querySelector("section.bg-gray-900")!.scrollIntoView({
        behavior: "smooth",
        block: "start",
      });
    } catch (error) {
      console.error("Error al cargar posts:", error);
      alert("Error al cargar los posts. Por favor, intenta de nuevo.");
    } finally {
      state.isLoading = false;
      elements.loading.classList.add("hidden");
      elements.postsContainer.classList.remove("opacity-50");
    }
  }

  // Función para cambiar de categoría
  function changeCategory(category: any) {
    document.querySelectorAll<HTMLElement>(".category-btn").forEach((btn) => {
      if (btn.dataset.category === category) {
        btn.className =
          "category-btn inline-flex items-center gap-2 px-4 py-2 rounded-full border transition-all duration-300 bg-orange-500 border-orange-500 text-white shadow-lg shadow-orange-500/25";
      } else {
        btn.className =
          "category-btn inline-flex items-center gap-2 px-4 py-2 rounded-full border transition-all duration-300 bg-gray-700/50 border-gray-600 text-gray-300 hover:bg-gray-600 hover:border-gray-500";
      }
    });

    loadPosts(category, 1);
  }

  // Función para cambiar de página
  function changePage(page: any) {
    if (page < 1 || page > state.totalPages) return;
    loadPosts(state.currentCategory, page);
  }

  // Event Listeners
  document.querySelectorAll<HTMLElement>(".category-btn").forEach((btn) => {
    btn.addEventListener("click", () => changeCategory(btn.dataset.category));
  });

  elements.prevBtn.addEventListener("click", () =>
    changePage(state.currentPage - 1)
  );
  elements.nextBtn.addEventListener("click", () =>
    changePage(state.currentPage + 1)
  );
  elements.clearFilter.addEventListener("click", () => changeCategory("all"));
  elements.viewAllBtn.addEventListener("click", () => changeCategory("all"));

  // Renderizado inicial
  renderPosts();

  //
</script>
