---
import { Github, ExternalLink } from "lucide-astro";
import { techIcons } from "../../util/constants/TechIcons";
import { fetchProjectsFromCategory } from "../../services/wordpress";
import type { Project } from "../../interface";

let projects: Project[] = [];
let categories = ["all"];
let fetchError = false;

try {
  projects = await fetchProjectsFromCategory();
  categories = ["all", ...new Set(projects.map((p) => p.category || "general"))];
} catch (err) {
  console.error("Error cargando proyectos:", err);
  fetchError = true;
}
---

<section id="projects" class="py-16 bg-gray-800 text-white">
  <div class="flex flex-col w-full items-center pb-16">
    <h2 class="text-3xl font-bold text-white">
      Proyectos <span class="text-orange-500">Destacados</span>
    </h2>
    <p class="text-gray-400 mt-2 px-3 sm:px-0 max-w-2xl mx-auto font-medium text-center">
      Algunos de los proyectos en los que he trabajado recientemente.
    </p>
  </div>

  <div class="container mx-auto px-4">
    {fetchError ? (
      <p class="text-red-500 text-center">No se pudieron cargar los proyectos. Intenta nuevamente más tarde.</p>
    ) : (
      <>
        <!-- Filtros -->
        <div id="filter-tabs" class="flex flex-wrap justify-center gap-2 mb-8">
          {categories.map((cat) => (
            <button
              class={`filter-btn px-4 py-2 rounded-full cursor-pointer capitalize transition-colors ${
                cat === "all"
                  ? "bg-orange-500 text-white"
                  : "bg-gray-700 text-gray-300 hover:bg-gray-600"
              }`}
              data-category={cat}
            >
              {cat === "all" ? "All Projects" : cat}
            </button>
          ))}
        </div>

        <!-- Grid de proyectos -->
        <div id="projects-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
          {projects.map((project) => (
            <div
              class="project-card rounded-lg overflow-hidden shadow-lg transition-all hover:-translate-y-2 hover:shadow-xl border border-amber-100"
              data-category={project.category}
            >
              <div class="h-48 overflow-hidden bg-white">
                <a href={`/project/${project.id}`}>
                  <img
                    src={project.image}
                    alt={project.title}
                    class="w-full h-full object-cover transition-transform duration-500 hover:scale-110"
                  />
                </a>
              </div>
              <div class="p-4 bg-gray-800">
                <h3 class="text-xl font-bold mb-2">
                  <a href={`/project/${project.id}`} class="hover:text-orange-400">
                    {project.title}
                  </a>
                </h3>

                <!-- Tecnologías -->
                <div class="flex flex-wrap gap-2 items-center mb-3 text-xl">
                  {project.techStack?.map((tech) => {
                    const Icon = techIcons[tech];
                    return Icon ? <Icon class="w-6 h-6 text-white" title={tech} /> : null;
                  })}
                </div>

                <p class="text-gray-300 mb-3">{project.description}</p>
                <div class="mt-4 flex justify-between items-center">
                  <span class="inline-block px-3 py-1 bg-orange-500 bg-opacity-20 text-white rounded-full text-sm capitalize">
                    {project.category}
                  </span>
                  <div class="flex gap-4 items-center">
                    {project.githubUrl && (
                      <a
                        href={project.githubUrl}
                        target="_blank"
                        rel="noopener noreferrer"
                        class="text-gray-300 hover:text-white"
                      >
                        <Github class="w-5 h-5" stroke="currentColor" />
                      </a>
                    )}
                    {project.liveUrl && (
                      <a
                        href={project.liveUrl}
                        target="_blank"
                        rel="noopener noreferrer"
                        class="text-gray-300 hover:text-white"
                      >
                        <ExternalLink class="w-5 h-5" stroke="currentColor" />
                      </a>
                    )}
                  </div>
                </div>
              </div>
            </div>
          ))}
        </div>
      </>
    )}
  </div>
</section>

<script>
  const buttons = document.querySelectorAll(".filter-btn") as NodeListOf<HTMLButtonElement>;
  const cards = document.querySelectorAll(".project-card") as NodeListOf<HTMLDivElement>;

  buttons.forEach((btn) => {
    btn.addEventListener("click", () => {
      const category = btn.dataset.category;
      buttons.forEach((b) => {
        b.classList.remove("bg-orange-500", "text-white");
        b.classList.add("bg-gray-700", "text-gray-300");
      });
      btn.classList.add("bg-orange-500", "text-white");

      cards.forEach((card) => {
        if (category === "all" || card.dataset.category === category) {
          card.classList.remove("hidden");
        } else {
          card.classList.add("hidden");
        }
      });
    });
  });
</script>

