---
import { Github, ExternalLink } from "lucide-astro";
import sanitizeHtml from "sanitize-html";
import { techIcons } from "../../util/constants/TechIcons";

interface WpMedia {
  source_url: string;
}

interface ProjectPost {
  id: number;
  title: { rendered: string };
  content?: { rendered: string };
  date: string;
  acf?: {
    githubUrl?: string;
    liveurl?: string;
    techstack?: string[];
  };
  _embedded?: {
    "wp:featuredmedia"?: WpMedia[];
  };
}

const { id } = Astro.params;
const postsEndpoint = import.meta.env.VITE_WORDPRESS_API_URL;

if (!postsEndpoint) throw new Error("Falta VITE_WORDPRESS_API_URL");

const base = postsEndpoint.replace("?rest_route=/wp/v2/posts", "");
const url = `${base}?rest_route=/wp/v2/posts/${id}&_embed`;

const res = await fetch(url);
if (!res.ok) throw new Error(`WP error ${res.status}`);
const post: ProjectPost = await res.json();

const featured =
  post._embedded?.["wp:featuredmedia"]?.[0]?.source_url ||
  "https://images.unsplash.com/photo-1517694712202-14dd9538aa97?q=80&w=1470&auto=format&fit=crop";

const techStack: string[] = Array.isArray(post.acf?.techstack)
  ? post.acf!.techstack
  : [];

const safeContent = sanitizeHtml(post.content?.rendered || "", {
  allowedTags: [
    ...sanitizeHtml.defaults.allowedTags,
    "ul",
    "ol",
    "li",
    "img",
    "figure",
    "figcaption",
    "iframe",
    "video",
    "source",
  ],
  allowedAttributes: {
    ...sanitizeHtml.defaults.allowedAttributes,
    "*": ["class", "style"],
    ul: ["class", "style", "type"],
    ol: ["class", "style", "type", "start"],
    li: ["class", "style"],
    img: [
      "src",
      "alt",
      "title",
      "loading",
      "width",
      "height",
      "srcset",
      "sizes",
    ],
    iframe: [
      "src",
      "width",
      "height",
      "allowfullscreen",
      "loading",
      "title",
    ],
  },
});
---

<div class="min-h-screen bg-gray-900 text-white">
  <div class="relative w-full h-[40vh] bg-gray-800">
    <img
      src={featured}
      alt={post.title.rendered}
      class="w-full h-full object-cover opacity-60"
    />
    <div class="absolute inset-0 bg-gradient-to-b from-gray-900/60 to-gray-900/90"></div>
    <div class="absolute bottom-0 left-0 right-0 p-6">
      <div class="max-w-5xl mx-auto">
        <h1 class="text-3xl md:text-4xl font-bold" set:html={post.title.rendered}></h1>
        {techStack.length > 0 && (
          <div class="flex gap-3 mt-4 text-2xl">
            {techStack.map((t) => (
              <span title={t}>{techIcons[t]}</span>
            ))}
          </div>
        )}
      </div>
    </div>
  </div>

  <article class="max-w-5xl mx-auto px-4 py-10">
    <div
      class="project-content prose prose-invert max-w-none prose-headings:text-white prose-p:text-gray-300 prose-strong:text-white prose-a:text-orange-400"
      set:html={safeContent}
    ></div>

    <div class="mt-8 flex gap-4">
      {post.acf?.githubUrl && (
        <a
          href={post.acf.githubUrl}
          target="_blank"
          rel="noopener noreferrer"
          class="px-4 py-2 bg-gray-800 rounded hover:bg-gray-700 flex items-center gap-2"
        >
          <Github class="w-5 h-5" stroke="currentColor" />
          GitHub
        </a>
      )}
      {post.acf?.liveurl && (
        <a
          href={post.acf.liveurl}
          target="_blank"
          rel="noopener noreferrer"
          class="px-4 py-2 bg-orange-600 rounded hover:bg-orange-500 flex items-center gap-2"
        >
          <ExternalLink class="w-5 h-5" stroke="currentColor" />
          Ver sitio
        </a>
      )}
    </div>

    <div class="mt-8">
      <a href="/" class="text-orange-400 hover:text-orange-300">
        ‚Üê Volver
      </a>
    </div>
  </article>
</div>

<style>
.project-content ul,
.project-content ol {
  margin: 1rem 0;
  padding-left: 2rem;
  list-style-position: outside;
}

.project-content ul {
  list-style-type: disc;
}

.project-content ol {
  list-style-type: decimal;
}

.project-content li {
  margin: 0.5rem 0;
  color: #d1d5db;
  line-height: 1.75;
}

.project-content ul li::marker,
.project-content ol li::marker {
  color: #f97316;
}

.wp-block-gallery {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
  gap: 1rem;
}

.wp-block-gallery figure {
  margin: 0;
  border-radius: 8px;
  overflow: hidden;
  transition: transform 0.3s ease;
}

.wp-block-gallery figure:hover {
  transform: scale(1.05);
}

.wp-block-code {
  background-color: #2d3748 !important;
  color: white !important;
  padding: 1rem;
  border-radius: 0.375rem;
  overflow-x: auto;
}
</style>
