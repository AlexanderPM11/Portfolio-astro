---
import { Youtube, Menu, X } from "lucide-astro";
import Logo from "../assets/img/Logo.png";
import Button from "./common/Button.astro";
---

<header
  id="site-header"
  class="fixed top-0 left-0 w-full z-100 transition-all duration-300 bg-transparent py-4"
>
  <div class="container mx-auto px-4 flex justify-between items-center">
    <div class="">
      <a
        href="/"
        class="flex items-center"
        onclick="window.scrollTo({top: 0, behavior: 'smooth'})"
      >
        <img src={Logo.src} alt="Logo" class="h-10" />
      </a>
    </div>

    <!-- Navegación Desktop -->
    <nav class="hidden lg:flex flex-1 justify-center items-center space-x-8">
      <a href="/" class="nav-link" data-target="#hero">Inicio</a>
      <a href="/#projects" class="nav-link" data-target="#projects">Proyectos</a
      >
      <a href="/#skills" class="nav-link" data-target="#skills">Habilidades</a>
      <a href="/#services" class="nav-link" data-target="#services">Servicios</a
      >
      <a href="/#about" class="nav-link" data-target="#about">Sobre mí</a>
      <a href="/#testimonials" class="nav-link" data-target="#testimonials"
        >Testimonios</a
      >
      <a href="/#contact" class="nav-link" data-target="#contact">Contacto</a>
      <a href="/blog" class="nav-link">Blog</a>
    </nav>

    <div class="hidden lg:flex items-center space-x-4">
      <Button
        variant="secondary"
        href="https://www.youtube.com/@alexanderdev-dd9wk"
        target="_blank"
        icon={Youtube}
        class="!hover:bg-white/75 hover:text-red-500"
        iconPosition="left"
      >
        YouTube
      </Button>
    </div>

    <!-- Botón Hamburguesa -->
    <button
      id="menu-toggle"
      class="lg:hidden p-3 bg-white/10 hover:bg-white/20 backdrop-blur-sm rounded-xl border border-white/20 transition-all duration-300 group cursor-pointer hover:scale-105 hover:shadow-lg hover:shadow-orange-500/20"
      aria-label="Abrir menú"
    >
      <Menu
        class="w-5 h-5 text-white group-hover:text-orange-400 transition-colors duration-300"
        stroke="currentColor"
      />
    </button>
  </div>

  <!-- Menú móvil -->
  <div
    id="mobile-menu"
    class="h-screen fixed inset-0 bg-gray-900/95 backdrop-blur-sm z-40 flex-col items-center justify-center hidden lg:hidden p-6"
  >
    <a
      href="/"
      class="flex items-center"
      onclick="window.scrollTo({top: 0, behavior: 'smooth'})"
    >
      <img src={Logo.src} alt="Logo" class="h-10" />
    </a>
    <!-- Botón cerrar -->
    <button
      id="menu-close"
      class="cursor-pointer absolute top-6 right-6 text-white hover:text-orange-500 transition-colors lg:hidden p-3 bg-white/10 hover:bg-white/20 backdrop-blur-sm rounded-xl border border-white/20 duration-300 group hover:scale-105 hover:shadow-lg hover:shadow-orange-500/20"
    >
      <X class="w-5 h-5" stroke="currentColor" />
    </button>

    <!-- Navegación -->

    <nav class="flex flex-col items-start gap-4 mt-16 text-lg font-medium">
      <a href="/" class="mobile-link" data-target="#hero">Inicio</a>
      <a href="/#projects" class="mobile-link" data-target="#projects"
        >Proyectos</a
      >
      <a href="/#skills" class="mobile-link" data-target="#skills"
        >Habilidades</a
      >
      <a href="/#services" class="mobile-link" data-target="#services"
        >Servicios</a
      >
      <a href="/#about" class="mobile-link" data-target="#about">Sobre mí</a>
      <a href="/#testimonials" class="mobile-link" data-target="#testimonials"
        >Testimonios</a
      >
      <a href="/#contact" class="mobile-link" data-target="#contact">Contacto</a
      >
      <a href="/blog" class="mobile-link">Blog</a>

      <!-- Botón de YouTube usando tu componente -->
      <div class="mt-6 ml-3">
        <Button
          variant="secondary"
          href="https://www.youtube.com/@alexanderdev-dd9wk"
          target="_blank"
          icon={Youtube}
          class="!hover:bg-white/75 hover:text-red-500"
          iconPosition="left"
        >
          YouTube
        </Button>
      </div>
    </nav>
  </div>
</header>

<script>
  const header = document.getElementById("site-header")!;
  const toggle = document.getElementById("menu-toggle")!;
  const close = document.getElementById("menu-close")!;
  const menu = document.getElementById("mobile-menu")!;
  const links = document.querySelectorAll(".mobile-link, .nav-link")!;

  // Función para verificar si estamos en una página de blog
  function isBlogPage() {
    const path = window.location.pathname;
    return path === "/blog" || /^\/blog\/.+/.test(path);
  }

  // Función para activar el enlace del blog
  function activateBlogLink() {
    links.forEach((link) => {
      if (link.getAttribute("href") === "/blog") {
        link.classList.add("active");
      } else {
        link.classList.remove("active");
      }
    });
  }

  // Función para activar enlace basado en la URL actual
  function activateCurrentPageLink() {
    const currentPath = window.location.pathname;
    const currentHash = window.location.hash;

    // Si estamos en una página de blog, activar el enlace del blog
    if (isBlogPage()) {
      activateBlogLink();
      return;
    }

    // Si estamos en la página principal con hash, usar el observer
    if (currentPath === "/" && currentHash) {
      // El IntersectionObserver se encargará de esto
      return;
    }

    // Para otras páginas, activar el enlace correspondiente
    links.forEach((link) => {
      const linkHref = link.getAttribute("href");
      if (
        linkHref === currentPath ||
        (currentPath === "/" && linkHref === "/")
      ) {
        link.classList.add("active");
      } else {
        link.classList.remove("active");
      }
    });
  }

  // Toggle menú móvil
  toggle.addEventListener("click", () => {
    menu.classList.remove("hidden");
    toggle.classList.add("hidden");
    close.classList.remove("hidden");
  });

  close.addEventListener("click", () => {
    menu.classList.add("hidden");
    toggle.classList.remove("hidden");
    close.classList.add("hidden");
  });

  // Smooth scroll + cerrar menú al hacer clic en link
  links.forEach((link) => {
    link.addEventListener("click", (e) => {
      const targetId = link.getAttribute("data-target");
      const href = link.getAttribute("href");
      const isBlogLink = href === "/blog";

      // Si es un enlace del blog, activarlo inmediatamente
      if (isBlogLink) {
        links.forEach((l) => l.classList.remove("active"));
        link.classList.add("active");
      }

      // Cerrar menú móvil si está abierto
      if (!link.classList.contains("nav-link")) {
        menu.classList.add("hidden");
        toggle.classList.remove("hidden");
        close.classList.add("hidden");
      }

      // Manejar smooth scroll solo para enlaces internos en la página principal
      if (
        targetId &&
        targetId.startsWith("#") &&
        window.location.pathname === "/"
      ) {
        e.preventDefault();
        const el = document.querySelector(targetId);
        if (el) {
          const offset = el.getBoundingClientRect().top + window.scrollY - 80;
          window.scrollTo({ top: offset, behavior: "smooth" });
        }
      }
    });
  });

  // Scroll effect para el header
  window.addEventListener("scroll", () => {
    if (window.scrollY > 50) {
      header.classList.add(
        "bg-gray-900/90",
        "shadow-lg",
        "py-3",
        "backdrop-blur-md"
      );
      header.classList.remove("bg-transparent", "py-4");
    } else {
      header.classList.remove(
        "bg-gray-900/90",
        "shadow-lg",
        "py-3",
        "backdrop-blur-md"
      );
      header.classList.add("bg-transparent", "py-4");
    }
  });

  // IntersectionObserver para resaltar sección activa (solo en página principal)
  const observer = new IntersectionObserver(
    (entries) => {
      // Solo aplicar en la página principal que no sea blog
      if (window.location.pathname !== "/" || isBlogPage()) return;

      entries.forEach((entry) => {
        if (entry.isIntersecting) {
          links.forEach((l) => l.classList.remove("active"));
          const active = document.querySelector(
            `[data-target="#${entry.target.id}"]`
          );
          if (active) {
            active.classList.add("active");
          }
        }
      });
    },
    { threshold: 0.4 }
  );

  // Solo observar secciones si estamos en la página principal
  if (window.location.pathname === "/" && !isBlogPage()) {
    document
      .querySelectorAll("section[id]")
      .forEach((section) => observer.observe(section));
  }

  // Activar el enlace correcto al cargar la página
  document.addEventListener("DOMContentLoaded", () => {
    activateCurrentPageLink();
  });

  // También activar cuando cambia la URL (navegación SPA)
  window.addEventListener("popstate", activateCurrentPageLink);
</script>
